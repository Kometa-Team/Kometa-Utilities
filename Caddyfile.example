# Caddyfile Example for AniDB Service
# Copy this file to 'Caddyfile' and customize for your deployment

# ============================================================================
# PATH-BASED ROUTING (Multiple services on one domain)
# ============================================================================
# Uncomment and customize this section if deploying at yourdomain.com/anidb-service

yourdomain.com {
    # Handle errors (like when the backend is down)
    handle_errors {
        @maintenance expression {err.status_code} in [502, 503, 504]
        handle @maintenance {
            rewrite * /maintenance.html
            file_server {
                root /var/www/html
            }
        }
    }

    # ========================================================================
    # IMPORTANT: OAuth Callback Routes - Must bypass authentication
    # ========================================================================
    # If using basic auth, these callback routes MUST be defined BEFORE the
    # basicauth directive. External services (Plex, MyAnimeList) cannot 
    # authenticate, so callbacks must be publicly accessible.
    # ========================================================================
    
    # MyAnimeList OAuth callback - NO AUTH
    handle /trakt-mal-oauth/mal/callback* {
        uri strip_prefix /trakt-mal-oauth
        reverse_proxy trakt-mal-oauth:5000
    }
    
    # Plex OAuth callback - NO AUTH
    handle /plex-oauth/auth/callback* {
        uri strip_prefix /plex-oauth
        reverse_proxy plex-oauth:5000
    }

    # ========================================================================
    # Optional: Basic Authentication
    # ========================================================================
    # Uncomment to require authentication for all routes (except callbacks above)
    # Generate password hash: caddy hash-password
    # basicauth * {
    #     username $2a$14$your_bcrypt_hash_here
    # }

    # Handle /anidb-service path
    # NOTE: uri strip_prefix removes /anidb-service before sending to backend
    # FastAPI receives /stats instead of /anidb-service/stats
    handle /anidb-service* {
        uri strip_prefix /anidb-service
        reverse_proxy anidb-mirror:8000 {
            header_up X-Script-Name /anidb-service
        }
    }

    # Handle /plex-oauth path
    # Flask app for Plex OAuth authentication
    handle /plex-oauth* {
        uri strip_prefix /plex-oauth
        reverse_proxy plex-oauth:5000
    }

    # Handle /trakt-mal-oauth path
    # Flask app for Trakt and MyAnimeList OAuth authentication
    handle /trakt-mal-oauth* {
        uri strip_prefix /trakt-mal-oauth
        reverse_proxy trakt-mal-oauth:5000
    }

    # Handle root path - serve static landing page
    handle / {
        root * /var/www/html
        file_server
    }

    # Fallback for any other paths
    handle {
        respond "Service not found" 404

# anidb-service.yourdomain.com {
#     # Handle errors (like when the backend is down)
#     handle_errors {
#         @maintenance expression {err.status_code} in [502, 503, 504]
#         handle @maintenance {
#             rewrite * /maintenance.html
#             file_server {
#                 root /var/www/html
#             }
#         }
#     }
# 
#     # Proxy to FastAPI backend
#     reverse_proxy anidb-mirror:8000
# }

# ============================================================================
# NOTES
# ============================================================================
# 
# Path-based routing:
# - Set ROOT_PATH=/anidb-service in your .env file
# - Access at: https://yourdomain.com/anidb-service
# - Allows multiple services on one domain
#
# Subdomain routing:
# - Leave ROOT_PATH empty in your .env file
# - Access at: https://anidb-service.yourdomain.com
# - Simpler configuration for single service
#
# See docs/PATH_BASED_ROUTING.md for detailed configuration guide
