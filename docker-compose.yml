services:
  anidb-mirror:
    build: ./anidb-service
    container_name: anidb-mirror
    restart: unless-stopped
    env_file:
      - ./anidb-service/.env
    environment:
      - UVICORN_WORKERS=1  # Reduce for low-memory systems
    volumes:
      - anidb-data:/app/data
      - anidb-db:/app/database
      - ./anidb-service/seed_data:/app/seed_data:ro
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  plex-oauth:
    build: ./plex-oauth
    container_name: plex-oauth
    restart: unless-stopped
    env_file:
      - ./plex-oauth/.env
    environment:
      - ROOT_PATH=/plex-oauth
      - SECRET_KEY=${PLEX_SECRET_KEY:-changeme-generate-random-key}
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  trakt-mal-oauth:
    build: ./trakt-mal-oauth
    container_name: trakt-mal-oauth
    restart: unless-stopped
    env_file:
      - ./trakt-mal-oauth/.env
    environment:
      - ROOT_PATH=/trakt-mal-oauth
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./index.html:/var/www/html/index.html
      - ./maintenance.html:/var/www/html/maintenance.html
      - caddy_data:/data
      - caddy_config:/config

volumes:
  anidb-data:
  anidb-db:
  caddy_data:
  caddy_config: